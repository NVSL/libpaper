
ALL=pdf
OS=$(shell uname -s)
TAR=tar


TEX_FILES+=$(wildcard *.tex *.sty libpaper/*.tex libpaper/*.sty libpaper/*/*.cls) libpaper_metadata.tex
FIGS+=$(wildcard Figures/*.pdf Figures/*.png)
GRAPHS+=$(wildcard Graphs/*.pdf Graphs/*.png)
LIBPAPER_BIN='./libpaper/bin/'

ARXIV_FILES=$(TEX_FILES) $(FIGS) $(GRAPHS) 00README.XXX

PDFLATEX_BATCH_OPTIONS=-interaction=errorstopmode -halt-on-error

PANDOC=pandoc

PDF_TARGETS ?= paper.pdf
TEX_TARGETS = $(patsubst %.pdf,%.tex,$(PDF_TARGETS))

PDFLATEX=TEXINPUTS=./:./libpaper//: pdflatex

.PHONY: test_build clean

all: check $(ALL)
default: all

paper.pdf:  $(TEX_FILES) $(GRAPHS) $(FIGS) Makefile libpaper/common.bib paper.bib

.PHONY: wc
wc:
	@if ! which -s $(PANDOC); then echo You need to install $(PANDOC);  false; fi;
	@$(PANDOC)  $(TEX_TARGETS)  -w plain -o - |wc

singlefile.tex: $(filter-out singlefile.tex,$(TEX_FILES))
	echo "" > singlefile.tex
	while read line; do if [ "`echo $$line | grep '^\\input{' | tr '{' ' ' | tr '}' ' ' | awk '{print $$2}'`" == "" ]; then echo $$line >> singlefile.tex; else cat `echo $$line | grep '^\\input{' | tr '{' ' ' | tr '}' ' ' | awk '{print $$2}'`.tex >> singlefile.tex; fi; done < paper.tex

.PHONY: test
test:
	rm -rf /tmp/test_build
	git clone . /tmp/test_build
	git clone ./libpaper/ /tmp/test_build/libpaper
	(cd /tmp/test_build; $(MAKE) ; open paper.pdf || true)

.PHONY: pdf
pdf: $(PDF_TARGETS)

%.aux : %.tex $(TEX_FILES)
	$(PDFLATEX) $(PDFLATEX_BATCH_OPTIONS) $* 

%.bbl : %.aux 
	bibtex $* || true

%.pdf : %.bbl
	$(PDFLATEX) $(PDFLATEX_BATCH_OPTIONS) $*
	$(PDFLATEX) $(PDFLATEX_BATCH_OPTIONS) $*
	$(PDFLATEX) $(PDFLATEX_BATCH_OPTIONS) $*

%.docx: $(TEX_FILES)
	$(PANDOC) $*.tex -w docx -o $@

TEMP_DIR=/tmp/$(shell basename $(CURDIR))

%.grammarly.txt: $(TEX_FILES)
	rm -rf $(TEMP_DIR)
	mkdir -p $(TEMP_DIR)
	$(TAR) cf - $(ARXIV_FILES) paper.bbl | (cd $(TEMP_DIR); $(TAR) xf -)
	(cd $(TEMP_DIR); for i in $$(find . -name '*.tex'); do mv $$i $$i.bak; perl -ne 's/\~\\(footnote|cite)/\\$$1/g;print;' < $$i.bak > $$i;done)
	(cd $(TEMP_DIR); $(PANDOC) $*.tex -w plain -o - --wrap=none) > $@

%.txt: $(TEX_FILES)
	$(PANDOC) $*.tex -w plain -o $@ 

#%%-strip.tex:  $(TEX_FILES)
#	$(PANDOC) $*.tex -w latex -o $@

.PHONY: libpaper_metadata.tex
libpaper_metadata.tex:
	$(LIBPAPER_BIN)/check_release > $@ || true

.PHONY: release
release: $(patsubst %.pdf,%-release.pdf,$(PDF_TARGETS))


%-release.pdf:
	@if $(LIBPAPER_BIN)/check_release > /dev/null; then $(MAKE) default; else echo "Committed changes first" ;fi
	mv $*.pdf $@	

ARXIV_NAME=$(shell basename $(CURDIR))-arxiv

.PHONY: arxiv
arxiv: $(TEX_FILES) paper.bbl
	rm -rf $(ARXIV_NAME)
	mkdir -p $(ARXIV_NAME)
	$(TAR) cf - $(ARXIV_FILES) paper.bbl | (cd $(ARXIV_NAME); $(TAR) xf -)
	(cd $(ARXIV_NAME); for i in $$(find . -name '*.tex'); do mv $$i $$i.bak; perl -pe 's/(^|[^\\])%.*/\1%/' < $$i.bak > $$i; rm $$i.bak; done)
	(cd $(ARXIV_NAME);  $(PDFLATEX) $(TEX_TARGETS);  $(PDFLATEX) $(TEX_TARGETS); $(PDFLATEX) $(TEX_TARGETS); )
	$(TAR) czf $(ARXIV_NAME).tgz $(ARXIV_NAME)

.PHONY: clean
clean:
	rm -rf *.aux *.log *.bbl *.blg *.out $(PDF_TARGETS) libpaper_metadata.tex
	rm -rf paper_abbrv.bib 
	rm -rf _test_build

.PHONY: check
check:
	@if ! [ -d libpaper/.git ]; then echo "Your libpaper is not in its own git repo.  You _should_not_ include the contents of libpaper in your paper directory.  You should checkout libpaper, so the improvement you make will be available to other students"; false; fi
